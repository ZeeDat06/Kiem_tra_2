@model IEnumerable<Web.Client.Models.Challenge>
@{
    ViewData["Title"] = "Sàn đấu - Kèo & Giải trí";
    var members = ViewBag.Members as List<Web.Client.Models.Member>;
}

<style>
    .page-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        padding: 25px 30px;
        border-radius: 15px;
        color: white;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(240, 147, 251, 0.3);
    }
    .page-header h2 { margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
    .challenge-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden;
    }
    .challenge-card:hover {
        transform: translateY(-15px) scale(1.02);
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }
    .challenge-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 15px;
    }
    .challenge-card.status-open .card-header {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .challenge-card.status-closed .card-header {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    .card-animate {
        animation: cardFadeIn 0.6s ease forwards;
        opacity: 0;
    }
    @@keyframes cardFadeIn {
        from { opacity: 0; transform: translateY(30px) scale(0.9); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .participant-count { font-size: 2rem; font-weight: bold; color: #667eea; }
    .modal-header.bg-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important; }
    .modal-header.bg-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; }
    .modal-header.bg-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%) !important; }
    .modal-header.bg-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
</style>

<div class="page-header d-flex justify-content-between align-items-center animate__animated animate__fadeInDown">
    <h2><i class="bi bi-lightning me-2"></i>Sàn đấu - Kèo & Giải trí</h2>
    <button type="button" class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="bi bi-plus-lg me-1"></i>Tạo kèo mới
    </button>
</div>

@if (Model.Any())
{
    <div class="row">
        @{ var cardIndex = 0; }
        @foreach (var item in Model)
        {
            var statusClass = item.Status == Web.Client.Models.ChallengeStatus.Open ? "status-open" :
                              item.Status == Web.Client.Models.ChallengeStatus.Closed ? "status-closed" : "status-completed";
            <div class="col-md-4 mb-4">
                <div class="card challenge-card @statusClass card-animate" style="animation-delay: @(cardIndex * 0.1)s;">
                    <div class="card-header d-flex justify-content-between align-items-center text-white">
                        <span class="badge bg-light text-dark"><i class="bi bi-controller me-1"></i>@item.ModeDisplay</span>
                        <span class="@item.StatusBadgeClass">@item.StatusDisplay</span>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title fw-bold">@item.Title</h5>
                        <p class="text-muted small mb-3">
                            <i class="bi bi-person-circle me-1"></i>Tạo bởi: <strong>@item.Creator?.FullName</strong>
                        </p>
                        @if (!string.IsNullOrEmpty(item.Description))
                        {
                            <p class="card-text text-secondary">@item.Description</p>
                        }
                        @if (!string.IsNullOrEmpty(item.RewardDescription))
                        {
                            <div class="alert alert-warning py-2 mb-3">
                                <i class="bi bi-gift-fill text-warning me-1"></i>
                                <strong>Phần thưởng:</strong> @item.RewardDescription
                            </div>
                        }
                        @if (item.Mode == Web.Client.Models.ChallengeMode.MiniGame && item.EntryFee > 0)
                        {
                            <div class="alert alert-success py-2 mb-3">
                                <i class="bi bi-cash-coin text-success me-1"></i>
                                <strong>Lệ phí:</strong> @item.EntryFee.ToString("N0")đ<br/>
                                <span class="fs-5 fw-bold text-success">
                                    <i class="bi bi-piggy-bank me-1"></i>Quỹ: @item.TotalPot.ToString("N0")đ
                                </span>
                            </div>
                        }
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people-fill text-primary me-1"></i>
                            <span class="participant-count">@item.Participants.Count</span>
                            <small class="text-muted ms-1">người tham gia</small>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="btn-group w-100">
                            <button type="button" class="btn btn-info btn-sm" onclick="showDetails(@item.Id)">
                                <i class="bi bi-eye"></i> Chi tiết
                            </button>
                            <button type="button" class="btn btn-warning btn-sm" 
                                    onclick="showEdit(@item.Id, '@item.Title', '@(item.Description ?? "")', @item.CreatorId, @((int)item.Mode), '@item.RewardDescription', @item.EntryFee, @((int)item.Status))">
                                <i class="bi bi-pencil"></i> Sửa
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="showDelete(@item.Id, '@item.Title')">
                                <i class="bi bi-trash"></i> Xóa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            cardIndex++;
        }
    </div>
}
else
{
    <div class="text-center py-5 animate__animated animate__fadeIn">
        <i class="bi bi-emoji-neutral display-1 text-muted"></i>
        <p class="lead text-muted mt-3">Chưa có kèo nào. Hãy tạo kèo mới!</p>
    </div>
}

<!-- Modal Tạo mới -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="Create" method="post">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-lightning me-2"></i>Tạo Kèo mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                            <input type="text" name="Title" class="form-control" required placeholder="VD: Kèo Đơn thứ 7" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Người tạo <span class="text-danger">*</span></label>
                            <select name="CreatorId" class="form-select" required>
                                <option value="">-- Chọn người tạo --</option>
                                @if (members != null)
                                {
                                    @foreach (var m in members)
                                    {
                                        <option value="@m.Id">@m.FullName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea name="Description" class="form-control" rows="2" placeholder="Mô tả kèo đấu..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Chế độ</label>
                            <select name="Mode" class="form-select" id="createModeSelect">
                                <option value="0">Đơn (Singles)</option>
                                <option value="1">Đôi (Doubles)</option>
                                <option value="2">Mini-game</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="createEntryFeeGroup" style="display: none;">
                            <label class="form-label">Lệ phí tham gia</label>
                            <div class="input-group">
                                <input type="number" name="EntryFee" class="form-control" step="1000" value="0" />
                                <span class="input-group-text">đ</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phần thưởng</label>
                        <input type="text" name="RewardDescription" class="form-control" placeholder="VD: Chầu cafe, 20 quả trứng..." />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Hủy</button>
                    <button type="submit" class="btn btn-success"><i class="bi bi-check-lg me-1"></i>Tạo kèo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Chi tiết -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Chi tiết Kèo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Đang tải...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chỉnh sửa -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="Edit" method="post">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Chỉnh sửa Kèo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="Id" id="edit_id" />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                            <input type="text" name="Title" id="edit_title" class="form-control" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Người tạo</label>
                            <select name="CreatorId" id="edit_creator" class="form-select">
                                @if (members != null)
                                {
                                    @foreach (var m in members)
                                    {
                                        <option value="@m.Id">@m.FullName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea name="Description" id="edit_description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Chế độ</label>
                            <select name="Mode" id="edit_mode" class="form-select">
                                <option value="0">Đơn (Singles)</option>
                                <option value="1">Đôi (Doubles)</option>
                                <option value="2">Mini-game</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Lệ phí</label>
                            <div class="input-group">
                                <input type="number" name="EntryFee" id="edit_entryfee" class="form-control" step="1000" />
                                <span class="input-group-text">đ</span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Trạng thái</label>
                            <select name="Status" id="edit_status" class="form-select">
                                <option value="0">Đang mở</option>
                                <option value="1">Đã đóng</option>
                                <option value="2">Đã hoàn thành</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phần thưởng</label>
                        <input type="text" name="RewardDescription" id="edit_reward" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Hủy</button>
                    <button type="submit" class="btn btn-warning"><i class="bi bi-check-lg me-1"></i>Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Delete" method="post">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-trash me-2"></i>Xác nhận xóa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="delete_id" />
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle text-warning display-1"></i>
                        <p class="mt-3 fs-5">Bạn có chắc chắn muốn xóa kèo</p>
                        <p class="fw-bold fs-4 text-danger" id="delete_name"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Hủy</button>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-trash me-1"></i>Xóa</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById('createModeSelect').addEventListener('change', function() {
        document.getElementById('createEntryFeeGroup').style.display = this.value === '2' ? 'block' : 'none';
    });

    function showDetails(id) {
        var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        var content = document.getElementById('detailsContent');
        content.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Đang tải...</p></div>';
        modal.show();
        
        fetch('/Challenges/Details/' + id)
            .then(response => response.text())
            .then(html => {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var cardBody = doc.querySelector('.card-body');
                content.innerHTML = cardBody ? cardBody.innerHTML : '<p>Không tìm thấy dữ liệu</p>';
            })
            .catch(err => {
                content.innerHTML = '<div class="alert alert-danger">Lỗi tải dữ liệu</div>';
            });
    }

    function showEdit(id, title, description, creatorId, mode, reward, entryFee, status) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_creator').value = creatorId;
        document.getElementById('edit_mode').value = mode;
        document.getElementById('edit_reward').value = reward;
        document.getElementById('edit_entryfee').value = entryFee;
        document.getElementById('edit_status').value = status;
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    function showDelete(id, title) {
        document.getElementById('delete_id').value = id;
        document.getElementById('delete_name').textContent = '"' + title + '"?';
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
</script>
}
